<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>القاضي السعودي | Saudi Judge AI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #09090b;
            --bg-secondary: #18181b;
            --bg-tertiary: #27272a;
            --accent: #005430;
            --accent-dim: #003d23;
            --accent-glow: rgba(0, 84, 48, 0.15);
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --border: #3f3f46;
            --user-bubble: #003d23;
            --ai-bubble: #27272a;
            --thinking-bg: #1a1a1d;
            --thinking-border: #52525b;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'IBM Plex Sans Arabic', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }
        
        header {
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .logo { font-size: 1.5rem; }
        
        header h1 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #00a66b;
            padding-bottom: 0.25rem;
            line-height: 1.6;
        }
        
        .status {
            margin-right: auto;
            margin-left: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .message {
            display: flex;
            flex-direction: column;
            max-width: 85%;
        }
        
        .message.user { align-self: flex-start; }
        .message.ai { align-self: flex-end; }
        
        .bubble {
            padding: 1rem 1.25rem;
            border-radius: 1rem;
            line-height: 1.7;
            font-size: 0.95rem;
        }
        
        .user .bubble {
            background: var(--user-bubble);
        }
        
        .ai .bubble {
            background: transparent;
            border: none;
        }
        
        /* Thinking Dropdown - ChatGPT Style */
        .thinking-dropdown {
            border-radius: 12px;
            overflow: hidden;
        }
        
        .thinking-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem 0.25rem;
            cursor: pointer;
            transition: background 0.2s;
            user-select: none;
        }
        
        .thinking-header:hover {
            background: transparent;
        }
        
        .thinking-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent);
        }
        
        .thinking-icon svg {
            width: 16px;
            height: 16px;
            transition: transform 0.2s;
        }
        
        .thinking-dropdown.open .thinking-icon svg {
            transform: rotate(90deg);
        }
        
        .thinking-title {
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .thinking-title .timer {
            color: var(--text-muted);
            font-size: 0.8rem;
        }
        
        .thinking-dots {
            display: flex;
            gap: 3px;
            margin-right: auto;
            margin-left: 0.5rem;
        }
        
        .thinking-dots span {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--accent);
            animation: bounce 1.4s infinite ease-in-out;
        }
        
        .thinking-dots span:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dots span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        .thinking-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .thinking-dropdown.open .thinking-content {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .thinking-content-inner {
            padding: 0.25rem 1rem 0.5rem;
            font-size: 0.85rem;
            line-height: 1.6;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            white-space: pre-wrap;
            direction: ltr;
            text-align: left;
            unicode-bidi: isolate;
        }
        
        /* Active thinking indicator */
        .thinking-active .thinking-header {
            background: transparent;
        }
        
        .input-area {
            padding: 1rem 1.5rem 1.5rem;
            display: flex;
            flex-direction: column-reverse;
            gap: 1rem;
        }
        
        .input-wrapper {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 2rem;
            padding: 0.6rem 1rem 0.6rem 1.25rem;
            transition: border-color 0.2s;
            order: 1;
        }
        
        .input-wrapper:focus-within {
            border-color: var(--accent);
        }
        
        textarea {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
            resize: none;
            outline: none;
            min-height: 24px;
            max-height: 150px;
            display: flex;
            align-items: center;
        }
        
        textarea::placeholder { color: var(--text-muted); padding-right: 0.5rem; }
        
        button {
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 0.75rem;
            padding: 0.5rem 1.25rem;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        button:hover {
            background: var(--accent-dim);
            transform: translateY(-1px);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .send-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--accent);
            color: white;
            flex-shrink: 0;
        }
        
        .send-btn:hover {
            background: var(--accent-dim);
            transform: none;
        }
        
        .send-btn:disabled {
            background: var(--text-muted);
        }
        
        .suggested-prompts {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            order: 2;
        }
        
        .prompt-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            border-radius: 2rem;
        }
        
        .prompt-btn:hover {
            background: var(--border);
            color: var(--text-primary);
            transform: none;
        }
        
        .welcome {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }
        
        .welcome h2 {
            font-size: 1.5rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
        
        /* Streaming cursor - shimmer sweep */
        .streaming-cursor {
            display: inline-block;
            margin-right: 2px;
            background: linear-gradient(
                90deg,
                var(--text-muted) 0%,
                var(--text-muted) 40%,
                var(--text-primary) 50%,
                var(--text-muted) 60%,
                var(--text-muted) 100%
            );
            background-size: 200% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: shimmer 2s infinite linear;
        }
        
        @keyframes shimmer {
            0% { background-position: -100% 0; }
            100% { background-position: 100% 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>القاضي السعودي</h1>
        </header>
        
        <div class="chat-area" id="chat">
            <div class="welcome">
                <h2>مرحباً بك في القاضي السعودي</h2>
                <p>اعطني قضية وسأقوم بتوقع نص الحكم والاسباب</p>
            </div>
        </div>
        
        <div class="input-area">
            <div class="input-wrapper">
                <textarea id="input" placeholder="اكتب سؤالك هنا..." rows="1"></textarea>
                <button id="send" class="send-btn" onclick="sendMessage()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="19" x2="12" y2="5"></line>
                        <polyline points="5 12 12 5 19 12"></polyline>
                    </svg>
                </button>
            </div>
            <div class="suggested-prompts">
                <button class="prompt-btn" onclick="usePrompt(this)" data-prompt="بناءً على القضية الابتدائية التالية، اكتب اسباب الابتدائية ونص حكم الابتدائية.\n\nوقائع الابتدائية:\nتتلخص وقائع هذه الدعوى في أنه سبق أن تقدم وكيل المدعية الموضحة بياناتها أعلاه بلائحة دعوى إلى المحكمة التجارية بالرياض ذكر فيها: أنه اتفق أطراف الدعوى على أن تورد المدعية للمدعى عليها خضار وفواكه، وتاريخ ابتداء التعامل 1443/09/24ه بثمن إجمالي قدره (193,745) مائة وثلاثة وتسعون ألفًا وسبعمائة وخمسة وأربعون ريالاً، وقد استلمت المدعى عليها كامل المبيع، وطالب بإلزام المدعى عليها بتسليم مبلغ العربون وقدره (193,745) مائة وثلاثة وتسعون ألفًا وسبعمائة وخمسة وأربعون ريالاً، وعقدت الدائرة جلسة مرئية في 1444/03/29ه وملخصها: حضر وكيل المدعية، ولم يحضر من يمثل المدعى عليها، وبسؤال المدعي وكالة عن دعوى موكلته وحصر طلباته وبيناته، فأحال على ما ورد في صحيفة الدعوى، وإلى الطلبات والبينات والأسانيد فيها، وقررت الدائرة صلاحية القضية للحكم وقفل باب المرافعة.">مثال: قضية ابتدائية</button>
                <button class="prompt-btn" onclick="usePrompt(this)" data-prompt="بناءً على قضية الاستئناف التالية، اكتب اسباب الاستئناف ونص حكم الاستئناف.\n\nوقائع الابتدائية:\nتتحصل وقائع الدعوى بالقدر اللازم لإصدار هذا الحكم في تقدم وكيل المدعي/ (...)، يحمل الهوية الوطنية رقم (...)، إلى المحكمة التجارية بالدمام بصحيفة دعوى يختصم فيها المدعى عليها، وأفاد في صحيفته بأن المدعي ساهم في تأسيس الشركة المدعى عليها، وشغل منصب رئيس مجلس إدارتها والعضو المنتدب للقيام بالأعمال الإدارية منذ تأسيسها في عام 2012م إلى بداية شهر يناير من عام 2014م، ثم عينت الشركة المدعى عليها مديراً عاماً في تاريخ 9/1/2013م إلى أن تقدم باستقالته في تاريخ 2/3/2014م، وتم تكليف المدعي ليتولى الأعمال الإدارية مؤقتاً، واستمر المدعي كعضو منتدب من تاريخ 12/3/2014م إلى تاريخ 1/11/2016م، وقرر مجلس إدارة المدعى عليها منح المدعي مبلغ مئتان ألف ريال (200,000) ريال مقابل أعماله الإدارية التي قدمها خلال فترة ثلاثة وثلاثون شهراً، واعترض المدعي على التعويض المقدر وتمسكت المدعى عليها به، وتقدم المدعي بالإخطار بالوفاء بتاريخ 30/12/2020م وعدلت المدعى عليها المبلغ المستحق إلى عشرة آلاف ريال (10,000) ريال شهرياً، بمجموع قدره ثلاثمائة وعشرة آلاف ريال (310,000) ريال، وحيث إن المدعي قد قام بالأعمال الموكلة إليه لمدة (33) شهراً وكذلك مدة (20) شهراً السابقة. وحيث إن التعويض عن الأعمال الإدارية وفقاً لتقدير الشركة وفقاً لخطابها المؤرخ في 13/1/2021م المقدر ب (10,000) عشرة آلاف ريال لم يلاق قبولاً من المدعي. وحيث جرى العمل في الشركة المدعى عليها أنها تمنح مبلغاً قدره (53,250) ثلاثة وخمسون ألفاً ومئتان وخمسون ريالاً شهرياً. ولما كان العضو المنتدب كٌلف بمهام إدارية لتسيير أعمال الشركة وهي لا تختلف عن مهام المدير التنفيذي الأمر الذي يستوجب الأخذ بعين الاعتبار ما صرفته الشركة للمدير السابق كأساس للاحتساب. وحيث إن الثابت من المستندات أن المدعى عليها تنازع في مقدار ما يستحقه المدعي وقدرته بمبلغ عشرة آلاف، وختم مذكرته بطلب إلزام المدعى عليها بدفع مبلغ قدره 2,822,250 نظير الأعمال التي كلف بها بصفته عضواً منتدباً جاء تفصيلها على النحو التالي: أولاً: إلزام المدعى عليها بتعويض المدعى بمبلغ وقدره (1,065,000) ريال مقابل (20شهراً) من الفترة (18/04/2012م إلى 01/01/2014م). ثانياً: إلزام المدعى عليها بإلزامها تعويض المدعي بمبلغ قدره (1,757,250) ريال مقابل (33شهراً) من الفترة (12/03/2014م إلى 01/11/2016م). ليصبح إجمالي المطالبة مبلغ وقدره (2,822,250) ريال. وفي سبيل نظر الدعوى عقدت الدائرة جلستها في يوم الثلاثاء 04/07/1442ه، حضر وكيل المدعي/ (...)، يحمل الهوية الوطنية رقم (...) بوكالة رقم (...)، كما حضر وكيل المدعى عليها/ (...)، يحمل الهوية الوطنية رقم (...)، واطلعت الدائرة على صحيفة الدعوى فتبين لها ما يؤثر على انعقاد الاختصاص لذا رفعت الجلسة للمداولة وإصدار الحكم.\n\nاسباب الابتدائية:\nفبناء على ما تقدم من الدعوى ولكون المدعي يهدف من إقامة دعواه إلى المطالبة بالمبلغ الوارد في صحيفة الدعوى نظير الأعمال التي كلف بها بصفته عضواً منتدباً للمدعى عليها قائما بمهام عمل المدير التنفيذي محتسبا أجر ذلك على أساس احتساب أجر المدير التنفيذي المعين سابقا، ولكون البحث في مسائل الاختصاص وشمول الدعوى المنظورة بولاية المحكمة مقدم على نظر أصل الحق، ولسماع الدائرة القدر الكافي الذي تستطيع معه البت في مسألة الاختصاص ولكون جوهر النزاع القائم متفرع عن علاقة عمل قائمة على أساس تبعية العامل لرب العمل وإشرافه المباشر على مهام عمله، يتمثل ذلك في صدور قرار الشركاء في تكليف المدعي بأعمال المدير التنفيذي، وهي إرادة صريحة أنشأت العلاقة العمالية وإن لم تكن مفرغة في قالب تعاقدي، لما جاء في المادة الثانية من نظام العمل والتي عرفت العمل بأنه &quot;الجهد المبذول في النشاطات الإنسانية كافة، تنفيذًا لعقد عمل (مكتوب أو غير مكتوب) بصرف النظر عن طبيعتها أو نوعها&quot;، يعضد ذلك طلب المدعي إلزام المدعى عليها بدفع أجره المبنى على احتساب أجر المدير التنفيذي السابق، الأمر الذي تنتهي معه الدائرة إلى عدم انعقاد الاختصاص لنظر النزاع القائم.\n\nنص حكم الابتدائية:\nحكمت الدائرة بعدم قبول الدعوى المقامة من المدعي/ (...) - هوية وطنية رقم (...)، ضد المدعى عليها/ شركة (...) للخدمات المساندة مساهمة مقفلة - سجل تجاري رقم (...) لما هو موضح بالأسباب والله الموفق وصلى الله على نبينا محمد وعلى آله وصحبه وسلم.\n\nوقائع الاستئناف:\nتتلخص واقعات هذه القضية بما أورده الحكم محل الاعتراض؛ وتحيل إليه الدائرة وقائع وأسباباً وفقًا للمادة (76/2) من نظام المحاكم التجارية، وقد أصدرت الدائرة ناظرة القضية حكمها فيها القاضي بعدم قبول الدعوى المقامة من (...) هوية وطنية رقم (...) ضد المدعى عليها شركة (...) للخدمات المساندة مساهمة مقفلة سجل تجاري رقم (...) وقد اعترض على ذلك وكيل المدعية، حيث قدم اعتراضه المرفق بملف القضية المتضمن (إن المدعي عضواً منتدباً في المدعى عليها ويمارس الأعمال الإدارية فيها، و طبيعة عمل العضو المنتدب تختلف عن طبيعة العامل حيث يمارس أعماله من دون تبعية فلا يحكمها نظام العمل، ومنشأ الاستحقاق في هذه المطالبة ناشئا عن تطبيق نظام الشركات فتكون داخلة في اختصاص المحكمة التجارية استنادا إلى الفقرة الرابعة من المادة (16) من نظام المحاكم التجارية، وطلب إلغاء الحكم)، وبإحالة القضية إلى هذه الدائرة اطلعت على ملفها والحكم الصادر فيها والاعتراض المقدم عليه، و رأت رفع الجلسة للمداولة وإصدار الحكم.">مثال: قضية استئناف</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION - Production (Vercel)
        // ============================================
        const CHAT_URL = '/api/chat';
        const HEALTH_URL = '/api/health';
        
        const chat = document.getElementById('chat');
        const input = document.getElementById('input');
        const sendBtn = document.getElementById('send');
        const statusDot = document.querySelector('.status-dot');
        const statusText = document.querySelector('.status span:last-child');
        
        // Check backend health on load
        async function checkHealth() {
            try {
                const response = await fetch(HEALTH_URL);
                const data = await response.json();
                console.log('Health check:', data);
                
                if (data.status === 'ok' && data.configured) {
                    statusDot.style.background = '#22c55e';
                    statusText.textContent = 'متصل';
                } else if (data.status === 'ok') {
                    statusDot.style.background = '#f59e0b';
                    statusText.textContent = 'غير مهيأ';
                } else {
                    statusDot.style.background = '#f59e0b';
                    statusText.textContent = 'حالة غير معروفة';
                }
            } catch (error) {
                console.error('Health check failed:', error);
                statusDot.style.background = '#ef4444';
                statusText.textContent = 'غير متصل';
            }
        }
        
        // Check health on page load and periodically
        checkHealth();
        setInterval(checkHealth, 30000);
        
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        input.addEventListener('input', () => {
            input.style.height = 'auto';
            input.style.height = Math.min(input.scrollHeight, 150) + 'px';
            applyDirection(input, input.value);
        });
        
        function usePrompt(btn) {
            const prompt = btn.dataset.prompt || btn.textContent;
            input.value = prompt.replace(/\\n/g, '\n');
            sendMessage();
        }
        
        function addMessage(content, isUser) {
            const welcome = chat.querySelector('.welcome');
            if (welcome) welcome.remove();
            
            const msg = document.createElement('div');
            msg.className = `message ${isUser ? 'user' : 'ai'}`;
            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            bubble.innerHTML = formatContent(content);
            applyDirection(bubble, content);
            msg.appendChild(bubble);
            chat.appendChild(msg);
            chat.scrollTop = chat.scrollHeight;
            return msg;
        }
        
        function createThinkingDropdown() {
            const dropdown = document.createElement('div');
            dropdown.className = 'thinking-dropdown thinking-active';
            dropdown.innerHTML = `
                <div class="thinking-header" onclick="this.parentElement.classList.toggle('open')">
                    <div class="thinking-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                    <div class="thinking-title">
                        <span>جارٍ التفكير</span>
                        <span class="timer"></span>
                    </div>
                    <div class="thinking-dots">
                        <span></span><span></span><span></span>
                    </div>
                </div>
                <div class="thinking-content">
                    <div class="thinking-content-inner"></div>
                </div>
            `;
            return dropdown;
        }
        
        function escapeHtml(text) {
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }
        
        function postProcess(text) {
            return text.replace(/\n?(نص حكم (?:الابتدائية|الاستئناف):)\n?/g, '\n\n$1\n');
        }
        
        function formatContent(text) {
            text = postProcess(text);
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/### (.*?)(\n|$)/g, '<h4>$1</h4>')
                .replace(/\n/g, '<br>');
        }
        
        function formatThinking(text) {
            return escapeHtml(text).replace(/\n/g, '<br>');
        }
        
        function detectDirection(text) {
            // Find first letter (skip whitespace, punctuation, numbers)
            const match = text.match(/[\p{L}]/u);
            if (!match) return 'rtl';
            const firstLetter = match[0];
            // Arabic Unicode range: \u0600-\u06FF
            const isArabic = /[\u0600-\u06FF]/.test(firstLetter);
            return isArabic ? 'rtl' : 'ltr';
        }
        
        function applyDirection(element, text) {
            const dir = detectDirection(text);
            element.style.direction = dir;
            element.style.textAlign = dir === 'rtl' ? 'right' : 'left';
        }
        
        function parseThinking(fullText) {
            // Parse <think>...</think> tags from Qwen model (handles unclosed tags too)
            // Only detect <think> if it's at the very beginning (after trimming whitespace)
            let thinking = '';
            let response = fullText;
            let isThinkingComplete = true;
            
            const trimmed = fullText.trimStart();
            if (!trimmed.startsWith('<think>')) {
                return { thinking, response, isThinkingComplete };
            }
            
            const openTagIndex = fullText.indexOf('<think>');
            const closeTagIndex = fullText.lastIndexOf('</think>');
            
            if (closeTagIndex !== -1 && closeTagIndex > openTagIndex) {
                thinking = fullText.substring(openTagIndex + 7, closeTagIndex);
                response = fullText.substring(closeTagIndex + 8).trim();
            } else {
                thinking = fullText.substring(openTagIndex + 7);
                response = '';
                isThinkingComplete = false;
            }
            
            return { thinking, response, isThinkingComplete };
        }
        
        async function sendMessage() {
            const text = input.value.trim();
            if (!text) return;
            
            input.value = '';
            input.style.height = 'auto';
            sendBtn.disabled = true;
            
            addMessage(text, true);
            
            // Create AI message container
            const aiMsg = document.createElement('div');
            aiMsg.className = 'message ai';
            
            // Add thinking dropdown (hidden initially)
            const thinkingDropdown = createThinkingDropdown();
            thinkingDropdown.style.display = 'none';
            aiMsg.appendChild(thinkingDropdown);
            
            // Add response bubble
            const responseBubble = document.createElement('div');
            responseBubble.className = 'bubble';
            responseBubble.innerHTML = '<span class="streaming-cursor">الرجاء الانتظار</span>';
            aiMsg.appendChild(responseBubble);
            
            chat.appendChild(aiMsg);
            chat.scrollTop = chat.scrollHeight;
            
            const thinkingContent = thinkingDropdown.querySelector('.thinking-content-inner');
            const timerEl = thinkingDropdown.querySelector('.timer');
            const thinkingDots = thinkingDropdown.querySelector('.thinking-dots');
            
            // Timer variables (starts when <think> is detected)
            let thinkingStartTime = null;
            let timerInterval = null;
            
            let fullText = '';
            
            try {
                console.log('Streaming from backend...');
                const response = await fetch(CHAT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        if (line === '' || line.startsWith(':')) continue;
                        
                        if (line.startsWith('data:')) {
                            let data = line.slice(5);
                            if (data.startsWith(' ')) data = data.slice(1);
                            
                            if (data === '[DONE]') {
                                console.log('Stream complete');
                                continue;
                            }
                            
                            fullText += data;
                        } else {
                            fullText += '\n' + line;
                        }
                        
                        // Update UI with streaming content
                        const { thinking, response: responseText, isThinkingComplete } = parseThinking(fullText);
                        
                        if (thinking) {
                            if (!thinkingStartTime) {
                                thinkingStartTime = Date.now();
                                thinkingDropdown.style.display = '';
                                timerInterval = setInterval(() => {
                                    const elapsed = Math.floor((Date.now() - thinkingStartTime) / 1000);
                                    timerEl.textContent = `${elapsed}s`;
                                }, 1000);
                            }
                            if (isThinkingComplete && timerInterval) {
                                clearInterval(timerInterval);
                                timerInterval = null;
                                const elapsed = Math.floor((Date.now() - thinkingStartTime) / 1000);
                                timerEl.textContent = `فكّر لمدة ${elapsed} ثانية`;
                            }
                            thinkingContent.textContent = thinking;
                            thinkingDropdown.classList.add('open');
                        }
                        
                        // Only show response when we have actual response content
                        if (responseText) {
                            applyDirection(responseBubble, responseText);
                            responseBubble.innerHTML = formatContent(responseText) + '<span class="streaming-cursor">▌</span>';
                        } else if (!thinking) {
                            // No thinking tags, show full text directly
                            applyDirection(responseBubble, fullText);
                            responseBubble.innerHTML = formatContent(fullText) + '<span class="streaming-cursor">▌</span>';
                        }
                        
                        chat.scrollTop = chat.scrollHeight;
                    }
                }
                
                if (timerInterval) clearInterval(timerInterval);
                
                // Final parse and render
                const { thinking, response: responseText } = parseThinking(fullText);
                
                thinkingDropdown.classList.remove('thinking-active');
                thinkingDots.style.display = 'none';
                
                if (thinking && thinking.length > 10) {
                    const totalTime = thinkingStartTime ? Math.floor((Date.now() - thinkingStartTime) / 1000) : 0;
                    thinkingContent.innerHTML = formatThinking(thinking);
                    timerEl.textContent = `فكّر لمدة ${totalTime} ثانية`;
                    thinkingDropdown.style.display = '';
                    thinkingDropdown.classList.add('open');
                } else {
                    thinkingDropdown.style.display = 'none';
                }
                
                // Show response, or full text if no thinking tags were used
                const finalText = responseText || (thinking ? '' : fullText) || 'لم يتم استلام رد';
                applyDirection(responseBubble, finalText);
                responseBubble.innerHTML = formatContent(finalText);
                
            } catch (error) {
                console.error('Error:', error);
                if (timerInterval) clearInterval(timerInterval);
                thinkingDropdown.style.display = 'none';
                responseBubble.innerHTML = 'خطأ في الاتصال: ' + error.message;
            }
            
            sendBtn.disabled = false;
            chat.scrollTop = chat.scrollHeight;
        }
        
    </script>
</body>
</html>
